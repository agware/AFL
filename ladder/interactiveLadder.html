<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Ladder</title>

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">

    <style>

        circle {
            fill: #fff;
            stroke-width: 2px;
            stroke: #000;
        }

        text {
            font-family: 'Open Sans', sans-serif;
            font-size: 18px;
            fill: #000;
        }

        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 10px;
        }

        .interactive {
            cursor: pointer;
        }

        .uncertain {
            opacity: 0.5;
        }

    </style>

</head>
<body>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script type="text/javascript" src="utils.js"></script>
<script type="text/javascript" src="rounds.js"></script>

<script>

    const height = 900;
    const width = 1100;
    const margin = {'x': 140, 'y': 80, 'gapX': 90, 'gapY': 100};
    const teams = ['Adelaide', 'Brisbane', 'Bulldogs', 'Carlton', 'Collingwood', 'Fremantle', 'GWS', 'Melbourne'];
    const colour = {
        'Adelaide': '#ffe303',
        'Brisbane': '#b15928',
        'Bulldogs': '#1f78b4',
        'Carlton': '#253494',
        'Collingwood': '#000',
        'Fremantle': '#6a3d9a',
        'GWS': '#ff7f00',
        'Melbourne': '#e31a1c'
    };
    const logo = {
        'Adelaide': 'Adelaide.svg',
        'Brisbane': 'Brisbane.svg',
        'Bulldogs': 'Bulldogs.svg',
        'Carlton': 'Carlton.svg',
        'Collingwood': 'Collingwood.svg',
        'Fremantle': 'Fremantle.svg',
        'GWS': 'GWS.svg',
        'Melbourne': 'Melbourne.svg'
    };
    const fixture = [
        [['Carlton','Collingwood'],['Adelaide','GWS'],['Bulldogs','Fremantle'],['Melbourne','Brisbane']],
        [['Bulldogs','Adelaide'],['Carlton','GWS'],['Collingwood','Melbourne'],['Fremantle','Brisbane']],
        [['GWS','Fremantle'],['Brisbane','Collingwood'],['Bulldogs','Melbourne'],['Adelaide','Carlton']],
        [['Melbourne','Carlton'],['Brisbane','GWS'],['Bulldogs','Collingwood'],['Fremantle','Adelaide']],
        [['GWS','Melbourne'],['Carlton','Bulldogs'],['Fremantle','Collingwood'],['Adelaide','Brisbane']],
        [['Fremantle','Carlton'],['Brisbane','Bulldogs'],['Adelaide','Melbourne'],['Collingwood','GWS']],
        [['Melbourne','Fremantle'],['GWS','Bulldogs'],['Collingwood','Adelaide'],['Carlton','Brisbane']]
    ];

    // split points into each round
    // only need to modify on uncertain rounds
    // regenerate each time?
    let points = {'Adelaide': 0, 'Brisbane': 0, 'Bulldogs': 0, 'Carlton': 0, 'Collingwood': 0, 'Fremantle': 0, 'GWS': 0, 'Melbourne': 0};

    const certainWin = [
        ['Adelaide', 'Brisbane', 'Bulldogs', 'Carlton'],
        ['Adelaide', 'Brisbane', 'Carlton', 'Melbourne'],
        ['Adelaide', 'Brisbane', 'Melbourne'],
        ['Adelaide', 'Brisbane', 'Collingwood', 'Melbourne'],
        ['Brisbane', 'Carlton', 'Collingwood', 'GWS']
    ];
    const certainDraw = [[],[],['Fremantle', 'GWS'],[],[]];

    let svg = d3.select('body').append('svg')
        .attr('height', height)
        .attr('width', width);

    let background = svg.append('g');
    background.append('rect')
        .attr('x', margin.x - 40)
        .attr('y', margin.y + 50)
        .attr('width', 170)
        .attr('height', 500)
        .style('fill', '#e8e8ee');


    let ladder = svg.append('g');

    let roundNum = 0;

    listClub();

    generateRound(roundNum, true);
    listRound(roundNum, true);
    roundNum += 1;

    while(roundNum <= certainWin.length) {

        addWin(certainWin[roundNum-1]);
        addDraw(certainDraw[roundNum-1]);
        sortByPoints();
        generateRound(roundNum, true);
        listRound(roundNum, true);

        roundNum += 1;
    }


    const sidebarDim = {'height': 700, 'width': 250};
    let sidebar = svg.append('g')
        .attr('transform', 'translate(' + 830 + ',' + 55 + ')');

    while(roundNum <= fixture.length) {
        // generate sidebar
        let sidebarG = sidebar.append('g')
            .attr('transform', 'translate(0,' + ((roundNum - certainWin.length - 1) * sidebarDim.height/2) + ')');

        sidebarG.append('rect')
            .attr('height', sidebarDim.height/2)
            .attr('width', sidebarDim.width)
            .style('fill', '#fff')
            .style('stroke', '#000')
            .style('stroke-width', '2px');

        sidebarG.append('text')
            .attr('x', 90)
            .attr('y', 40)
            .text('Round ' + roundNum)
            .style('font-size', '20px')
            .style('font-weight', 'bold');

        // generate final rounds
        let round = fixture[roundNum-1];
        let winner = [];


        for(let i = 0; i < round.length; i++) {
            let team1 = round[i][0];
            let team2 = round[i][1];

            sidebarG.append('image')
                .attr('xlink:href', logo[team1])
                .attr('x', 10)
                .attr('y', 60 + 70*i)
                .datum(roundNum.toString() + i.toString())
                .attr('id', team1 + roundNum.toString() + i.toString())
                .classed('round' + roundNum.toString() + i.toString(), true)
                .classed('interactive', true)
                .classed('uncertain', true)
                .on('click', selectTeam);

            sidebarG.append('text')
                .attr('x', 118)
                .attr('y', 90 + 70*i)
                .text('vs')
                .style('font-weight', 'bold');

            sidebarG.append('image')
                .attr('xlink:href', logo[team2])
                .attr('x', 160)
                .attr('y', 60 + 70*i)
                .datum(roundNum.toString() + i.toString())
                .attr('id', team1 + roundNum.toString() + i.toString())
                .classed('round' + roundNum.toString() + i.toString(), true)
                .classed('interactive', true)
                .classed('uncertain', true)
                .on('click', selectTeam);

            let temp = points[team1] >= points[team2] ? team1 : team2;

            winner.push(temp);
        }

        addWin(winner);
        sortByPoints();
        generateRound(roundNum);
        listRound(roundNum);

        roundNum += 1;
    }

    function selectTeam() {

        let certainty = d3.select(this).classed('uncertain');
        let matchUp = d3.select(this).datum();
        console.log(matchUp);

        d3.selectAll('.round' + matchUp).classed('uncertain', certainty);
        d3.select(this).classed('uncertain', !certainty);

        // delete and regenerate round?
        // flow on effects?
        // delete and regenerate path?
    }

    // regenerate path each new round? Is this memory heavy?
    for (let x = 0; x < teams.length; x++) {
        let fixedData = ripData(teams[x], 0, certainWin.length);
        background.append('path')
            .datum(fixedData)
            .classed('line', true)
            .style('stroke', colour[teams[x]])
            .attr('d', d3.line()
                .curve(d3.curveMonotoneY)
                .x(function(d) { return d.x; })
                .y(function(d) { return d.y; })
            );
    }

    for (let x = 0; x < teams.length; x++) {
        let variableData = ripData(teams[x], certainWin.length, roundNum - 1);
        background.append('path')
            .datum(variableData)
            .classed('line', true)
            .style('stroke', colour[teams[x]])
            .style('stroke-opacity', 0.6)
            .attr('d', d3.line()
                .curve(d3.curveMonotoneY)
                .x(function(d) { return d.x; })
                .y(function(d) { return d.y; })
            );
    }

</script>

</body>
</html>